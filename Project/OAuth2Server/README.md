# OAuth2モジュールのインストール方法

## SecureFramework 1.0以前

OAuth2モジュールをgitから取得した後、Project配下に移動する。

OAuth2モジュール配下にあるmigrationの中にあるファイルを、フレームワーク側migrationの中に移動する。

## SecureFramework 1.0以降

```
composer require secure_module_project_oauth2
```
でインストールする

# OAuth2モジュールの依存関係。
SecureFramework 1.0以前であれば、Project配下に、Customerモジュールが存在することを必要とする。

# クライアント管理
管理画面に、「OauthClient 管理」が追加され、こちらで、連携対象アプリを登録する。

登録完了時、client_idおよびclient_secretが発行されます。

完了画面閉じた後は、client_secretを再確認する術がありませんので、必ずメモーしておく。

# スコープ
oauth認証に置いて、アプリが参照可能な情報領域。
configにより設定。
デフォルトで、basic・email を設定可能。

# AccessToken取得方法
１、アプリ側にて、ユーザーを下記urlにリダイレクトして認証認可してもらいます。

```
https://{oauth-server.domain}/rest/v1/oauth/authorize?client_id={client_id}&response_type=code&scope=basic email
```
ユーザーが認証後、OauthClient登録時に指定されたredirect_urlに、リダイレクトしてアプリに戻します。
アプリに戻す時、下記のように認証コードをパラメータで渡す。(urlは仮)

```
https://{app.domain}/oauth/callback?code={code}
```
２、アプリ側で受け取った認証コードを使い、accessTokenやrefreshTokenを取得する。
下記, curlによるrequestのサンプル

```
curl 'https://{oauth-server.domain}/rest/v1/oauth/access_token' -H 'accept: text/json' --data 'grant_type=authorization_code&client_id={client_id}&client_secret={client_secret}&code={code}'
```

レスポンス例

```
{"token_type":"Bearer","expires_in":3600,"access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6Ijc5OWY2Mzg5MmZiNzc2NzA2NWVjMmE2ZTdjMTVlZWM4ZWU0NmQwOGE2N2RhM2E5YjBmOWZiZmJjMjAxZjg4ZjQ5NGY3MWNjMGMwNDA4N2NlIn0.eyJhdWQiOiIyIiwianRpIjoiNzk5ZjYzODkyZmI3NzY3MDY1ZWMyYTZlN2MxNWVlYzhlZTQ2ZDA4YTY3ZGEzYTliMGY5ZmJmYmMyMDFmODhmNDk0ZjcxY2MwYzA0MDg3Y2UiLCJpYXQiOjE1NTI5NjM5MjMsIm5iZiI6MTU1Mjk2MzkyMywiZXhwIjoxNTUyOTY3NTIzLCJzdWIiOiJ7XCJ0eXBlXCI6XCJjdXN0b21lclwiLFwiaWRcIjoxfSIsInNjb3BlcyI6WyJiYXNpYyIsImVtYWlsIl19.Pm2RYeLUxSmTW_xmyZ1F_-J-lgfqSDnOL_jGK1U-uu1zJWx3F52ZfL7HrVrBpC1lnEp-ZcDTDf5QPxUREhdy_Zt2vurvQfikW76KIYRdrtB7DRL7O5taL_bqJfVey8u0EyIRWJYifMmY394GlplK6wyFusBKPRM5PBUUcK-hDA5I-1GEslm0rh46YGC7X7gL_xqdZLPldRqWzCRwa8Ss0ImWrAPyKJbdQeU8nstG9xca2h2QjSNOj4VHvUwfR8oHUYY6xTmyQ60-zuFzevGqk8mNkrXrEnHlzP47GOpEbvNnfkNcFjibCy7E-ESD8XHDGVnBsPw4QyVYJrlzqA7so7XQoojIjJXwc7LDraigBGjZJINgcxDOmACiLk19HvfHJEOKHGQvUpIN3_xE2Xsru0xuryXrn7tdiH9eLhsafjXRVN9NejVLGHJN0dtTOotJMwH1NaGo7N5jczaBjq3X3N_h7qoNRnpXInv9QtFUHgxAfQbGBn5_VFnZ8GAkZg0FDkWz-Jd_ASC7IxJIyw-UXi3Vtbxz1siByjRxZz98ktMmzuZEGWHcfXucwnHXCraRgeMXSToAApSyfuqw10Drqw1gN8iXZABa556Q4jjcKDcMOJiylxLdCbqlav8uS1vHLXL7JRyQAhBjMq4u_fC8pK6BqYIZlZ01IJa9lgVm0zs","refresh_token":"def502001b9095cdf350d51af5972c55b97e281426569dbd1c6fcd19ab1317e4594da45b69374ef7959b73443fa65687cd3c63694f90a970fd0f3d83883780021b2e0e69f8d30ed5cec351b3a7c521a650da867ff861c068068ffd6d867f43436e47b981d54dac10f33f2fc15d63c30f4629df6f3ad3c03856225204fefb1a4bf045e6661f7b6ff75e4968f636af0c53661aa594109d4f0e2b08815e5b3989bf6a7a42f64e2a99579b3ad6f1e6a97b4c1baabe83f70710db1ac5c4ddd5a74af44d25ce47762057a8fd76f18732ff1ca0b9cccb9e1c923280d16677d0b7d22462410b24aad745744b759bf7e033580cfb4a8cdf9a70b3089d2665c2a948d5f655f0718a5ab4f8bd818f4be24e0cd931157ff66a85c2e46f10554dd853baa5a99fc34a4a9eca38b65fdfab860b1cc85acd969a2ae68333e2936c81a9b1553a3cd70d89d47b980dda9cc58dad8adf75df9a3937179b20f14ff48666d979ca49e2aa9260009436ccb3af3c7a3a824bd4efd80a14229f888289b7287556960194970a8db3d972f3d36e429db38cd49fe303"}
```

３、取得したaccessTokenをヘッダーにつけて、サーバー側の各種APIをアクセスする

user profileを取得する例

```
curl 'https://docker.local/rest/v1/oauth/profile' -H 'accept: text/json' --header 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6Ijc5OWY2Mzg5MmZiNzc2NzA2NWVjMmE2ZTdjMTVlZWM4ZWU0NmQwOGE2N2RhM2E5YjBmOWZiZmJjMjAxZjg4ZjQ5NGY3MWNjMGMwNDA4N2NlIn0.eyJhdWQiOiIyIiwianRpIjoiNzk5ZjYzODkyZmI3NzY3MDY1ZWMyYTZlN2MxNWVlYzhlZTQ2ZDA4YTY3ZGEzYTliMGY5ZmJmYmMyMDFmODhmNDk0ZjcxY2MwYzA0MDg3Y2UiLCJpYXQiOjE1NTI5NjM5MjMsIm5iZiI6MTU1Mjk2MzkyMywiZXhwIjoxNTUyOTY3NTIzLCJzdWIiOiJ7XCJ0eXBlXCI6XCJjdXN0b21lclwiLFwiaWRcIjoxfSIsInNjb3BlcyI6WyJiYXNpYyIsImVtYWlsIl19.Pm2RYeLUxSmTW_xmyZ1F_-J-lgfqSDnOL_jGK1U-uu1zJWx3F52ZfL7HrVrBpC1lnEp-ZcDTDf5QPxUREhdy_Zt2vurvQfikW76KIYRdrtB7DRL7O5taL_bqJfVey8u0EyIRWJYifMmY394GlplK6wyFusBKPRM5PBUUcK-hDA5I-1GEslm0rh46YGC7X7gL_xqdZLPldRqWzCRwa8Ss0ImWrAPyKJbdQeU8nstG9xca2h2QjSNOj4VHvUwfR8oHUYY6xTmyQ60-zuFzevGqk8mNkrXrEnHlzP47GOpEbvNnfkNcFjibCy7E-ESD8XHDGVnBsPw4QyVYJrlzqA7so7XQoojIjJXwc7LDraigBGjZJINgcxDOmACiLk19HvfHJEOKHGQvUpIN3_xE2Xsru0xuryXrn7tdiH9eLhsafjXRVN9NejVLGHJN0dtTOotJMwH1NaGo7N5jczaBjq3X3N_h7qoNRnpXInv9QtFUHgxAfQbGBn5_VFnZ8GAkZg0FDkWz-Jd_ASC7IxJIyw-UXi3Vtbxz1siByjRxZz98ktMmzuZEGWHcfXucwnHXCraRgeMXSToAApSyfuqw10Drqw1gN8iXZABa556Q4jjcKDcMOJiylxLdCbqlav8uS1vHLXL7JRyQAhBjMq4u_fC8pK6BqYIZlZ01IJa9lgVm0zs'
```

レスポンス(例)

```
{
    "nameSei": "\u30c1\u30a7\u30f3",
    "nameMei": "\u30cf\u30f3",
    "email": "gpgkd906@gmail.com"
}
```

４、不正のaccessTokenでapiをアクセスされる場合は、response statusが500か404で空コンテンツを返却される